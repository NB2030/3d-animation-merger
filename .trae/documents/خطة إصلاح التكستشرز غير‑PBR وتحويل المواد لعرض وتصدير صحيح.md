## أهداف عامة
- تحديث الاعتماديات والأدوات لضمان توافق حديث وأداء أفضل.
- إصلاح عرض المواد غير‑PBR وتحويلها لوضع مناسب للتصدير.
- الحفاظ على وظائف دمج الحركات FBX→GLB دون كسر.

## نطاق التحديث الشامل
### التحديثات الأساسية
- ترقية `three` إلى إصدار حديث، ومراجعة التغييرات:
  - استبدال `renderer.outputEncoding` بـ `renderer.outputColorSpace`.
  - مراجعة استخدامات `Texture.encoding/ColorSpace`.
- ترقية `esbuild` ورفع `target` إلى `es2020`.
- إزالة أعلام Node غير الضرورية من سكربتات التشغيل.
- استبدال `scripts/GLTFExporter.js` باستيراد رسمي من `three/examples/jsm/exporters/GLTFExporter.js` إن لم توجد تخصيصات.

### جودة الكود والأداء
- إضافة التخلص من الموارد عند تبديل النموذج: `geometry/material/texture.dispose()`، وإيقاف `AnimationMixer`.
- استبدال `FileReader` بـ `file.arrayBuffer()` مع `async/await`.
- تقليل السجلات التشخيصية وإضافة معالجة أخطاء صامتة عند اللزوم.
- اختبار يدوي عبر معاينة وتشغيل حركات متعددة؛ ثم تصدير GLB والتحقق خارجيًا.

### تحسين تجربة التطوير
- خيار اعتماد `Vite` بدل `browser-sync` لاحقًا.
- إضافة `eslint/prettier` إن رغبت لتوحيد الأسلوب.

## إصلاح التكستشرز غير‑PBR
### تشخيص
- مواد Phong/Basic تبدو داكنة بسبب إنارة مادية وترميز لوني غير متسق.

### خطوات التنفيذ
1) تصحيح ترميز الألوان:
- بعد تحميل FBX، اضبط `material.map` على `sRGB`، واترك خرائط non‑color على ترميز خطي.
2) كشف المواد غير‑PBR:
- traverse للكائن لتصنيف المواد `Phong/Basic`.
3) وضع Unlit الافتراضي للنماذج "shaded":
- استبدال المادة بـ `MeshBasicMaterial` مع نقل `map/color/opacity/side`.
- يوفر المُصدِّر امتداد `KHR_materials_unlit` تلقائيًا.
4) تحويل تقريبي إلى PBR (اختياري):
- إنشاء `MeshStandardMaterial` بقيم ابتدائية: `metalness=0`، `roughness=1`.
- استخدام `shininess` لتقدير `roughness`، ومعالجة `specularMap` إن وجدت.
5) تحسين الإضاءة العامة:
- إضافة `HemisphereLight` + تعديل `AmbientLight`، وضبط `toneMappingExposure` عند الحاجة.
6) واجهة المستخدم:
- زر "Fix Textures" وتبديل `Unlit | PBR` لكل مادة.

## معالم التنفيذ
- المرحلة 1: ترقية الاعتماديات وضبط اللون والتخلص من الموارد.
- المرحلة 2: منطق إصلاح التكستشرز + واجهة المستخدم.
- المرحلة 3: اختبار شامل وتعديلات دقيقة.

## مخاطر وتخفيف
- تحويل `shininess→roughness` تقديري؛ وفّر منزلق يدوي.
- احتمال اختلافات طفيفة بعد ترقية `three`؛ نفّذ على فرع منفصل واختبر.

## مخرجات متوقعة
- عرض متسق للموديلات القديمة داخل العارض.
- GLB مُصدَّر يحافظ على الشكل عبر Unlit أو PBR.
- قاعدة كود مُحدثة يسهل صيانتها في المستقبل.